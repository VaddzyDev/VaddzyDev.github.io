<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vaddzy • Music Collab (Demo)</title>
  <meta name="description" content="Vaddzy - Where producers & artists meet to upload beats, follow, message, and collaborate." />
  <style>
    :root{
      --bg:#071026; --card:#07162b; --muted:#9aa4b2; --accent:#22c1c3; --accent-2:#60a5fa; --white:#ecf3f8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#041028 0%,#061427 100%);color:var(--white);min-height:100vh}
    a{color:var(--accent)}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:rgba(2,6,23,0.5);backdrop-filter:blur(6px);position:sticky;top:0;z-index:60;border-bottom:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#0ea5a7);display:flex;align-items:center;justify-content:center;font-weight:700}
    .title{font-weight:700;font-size:18px}
    header nav{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#022;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white)}
    .container{max-width:1100px;margin:20px auto;display:grid;grid-template-columns:1fr 340px;gap:20px;padding:0 16px}
    @media(max-width:980px){ .container{grid-template-columns:1fr} header nav .hide-sm{display:none} .sidebar{order:2} .main{order:1} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:12px;margin-bottom:16px}
    .compose{display:flex;gap:12px;align-items:flex-start}
    .avatar{width:56px;height:56px;border-radius:12px;background:#0b1320;display:flex;align-items:center;justify-content:center;font-weight:700}
    input[type="text"], input[type="email"], input[type="password"], textarea, select {
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white);
    }
    textarea{min-height:80px;resize:vertical}
    .file-row{display:flex;gap:10px;align-items:center}
    .feed .post{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);margin-bottom:18px}
    .post .post-head{display:flex;gap:12px;align-items:center;padding:10px}
    .post .post-head img{width:48px;height:48px;border-radius:10px;object-fit:cover}
    .post .media{width:100%;display:block;background:#000}
    .post .controls{display:flex;justify-content:space-between;align-items:center;padding:10px}
    .controls .left{display:flex;gap:12px;align-items:center}
    .likes-count{font-weight:700}
    .caption{padding:0 12px 10px;color:var(--white);opacity:0.95}
    .comments{padding:0 12px 12px}
    .comment-row{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
    .comment-row b{font-weight:700}
    .share{color:var(--accent-2);cursor:pointer;text-decoration:underline}
    .sidebar .profile{display:flex;gap:12px;align-items:center}
    .sidebar .socials a{display:block;color:var(--muted);margin-top:6px}
    .admin-table{width:100%;border-collapse:collapse}
    .admin-table th,.admin-table td{border-bottom:1px solid rgba(255,255,255,0.03);padding:8px;text-align:left;font-size:13px;color:var(--muted)}
    footer{padding:20px;text-align:center;color:var(--muted);margin-top:24px}
    .small{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}
    .danger{background:#ef4444;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    .pill{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;font-weight:700}
    .search{display:flex;gap:8px}
    .msg-item{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .follow-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white);cursor:pointer}
    .badge{background:var(--accent-2);color:#022;padding:4px 8px;border-radius:999px;font-weight:700}
    .center{display:flex;justify-content:center;align-items:center}
    .muted-2{color:rgba(255,255,255,0.55)}
    /* responsiveness */
    @media(max-width:600px){
      header{padding:10px}
      .logo{width:40px;height:40px}
    }
  </style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4759102262341082"
     crossorigin="anonymous"></script>
</head>
<body>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4759102262341082"
     data-ad-slot="YOUR_AD_SLOT_ID"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<header>
  <div class="brand">
    <div class="logo">V</div>
    <div>
      <div class="title" id="siteTitle">Vaddzy</div>
      <div class="small" id="siteDesc">Music • Beats • Collaboration</div>
    </div>
  </div>

  <nav>
    <div class="search" style="align-items:center">
      <input id="searchInput" placeholder="Search users..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)">
      <button class="btn ghost" id="btnSearch">Search</button>
    </div>
    <div style="width:12px"></div>
    <div id="authControls"></div>
  </nav>
</header>

<main class="container">
  <!-- MAIN FEED -->
  <section class="main">
    <!-- Compose -->
    <div id="composeCard" class="card" style="display:none">
      <div class="compose">
        <div class="avatar" id="composeAvatar">U</div>
        <div style="flex:1">
          <div class="small" id="composeUser">You</div>
          <textarea id="postCaption" placeholder="Beat title, bpm, mood..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <input type="file" id="postCover" accept="image/*">
            <input type="file" id="postAudio" accept="audio/*">
            <select id="postCategory" style="max-width:160px">
              <option value="beat">Beat</option><option value="sample">Sample</option><option value="tutorial">Tutorial</option>
            </select>
            <button class="btn" id="btnCreatePost">Post</button>
            <button class="btn ghost" id="btnClearPost">Clear</button>
          </div>
          <div class="small muted" style="margin-top:8px">Audio saved locally. For real-world use connect to backend storage (Firebase/S3).</div>
        </div>
      </div>
    </div>

    <!-- Feed -->
    <div id="feed"></div>

    <div id="noPosts" class="card" style="display:none">
      <h3>No posts yet</h3>
      <p class="muted">Register or log in to upload beats and start collaborating.</p>
    </div>
  </section>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="card profile-card" id="profileCard">
      <!-- filled by JS -->
    </div>

    <div class="card" id="authCard">
      <h3>Register / Login</h3>
      <div style="margin-top:8px">
        <input type="text" id="regName" placeholder="Full name" />
        <input type="text" id="regUser" placeholder="Username" style="margin-top:8px" />
        <input type="email" id="regEmail" placeholder="Email" style="margin-top:8px" />
        <input type="password" id="regPass" placeholder="Password" style="margin-top:8px" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="btnRegister">Register</button>
          <button class="btn ghost" id="btnOpenLogin">Login</button>
        </div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
        <input type="text" id="loginUser" placeholder="Username" />
        <input type="password" id="loginPass" placeholder="Password" style="margin-top:8px" />
        <button class="btn" id="btnLogin" style="margin-top:8px">Login</button>
      </div>
    </div>

    <div class="card" id="messagesCard" style="display:none">
      <h4>Messages</h4>
      <div id="msgList" style="max-height:220px;overflow:auto"></div>
      <div style="margin-top:10px" class="small muted">Open a conversation to send/receive private messages.</div>
    </div>

    <div class="card" id="adminCard" style="display:none">
      <h3>Admin Dashboard</h3>
      <div class="small muted">Manage users & posts</div>
      <div style="max-height:260px;overflow:auto;margin-top:12px">
        <table class="admin-table" id="adminUsers">
          <thead><tr><th>User</th><th>Actions</th></tr></thead><tbody></tbody>
        </table>
        <div style="height:12px"></div>
        <table class="admin-table" id="adminPosts"><thead><tr><th>Post</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>
      <div style="margin-top:10px;"><button class="btn ghost" id="btnEditSite">Edit Site</button></div>
    </div>

    <div class="card">
      <h4>About Vaddzy</h4>
      <p class="small muted">Music collaboration demo. Local-only data storage (browser). Connects producers & artists.</p>
      <div style="margin-top:10px" class="small muted">
        <div><b>Developer:</b> Gaston Manirafasha</div>
        <div>Email: <a href="mailto:gastonmanirafasha46@gmail.com">gastonmanirafasha46@gmail.com</a></div>
        <div>FB: <a href="https://www.facebook.com/profile.php?id=61562834675406" target="_blank">Facebook</a></div>
        <div>IG: <a href="https://www.instagram.com/vaddzy35?igsh=a3d2dXZ5OW9ia216" target="_blank">Instagram</a></div>
        <div>YT: <a href="https://www.youtube.com/@vaddzy" target="_blank">YouTube</a></div>
        <div>WA: <a href="https://wa.me/250736421989" target="_blank">+250 736 421 989</a></div>
        <div>TikTok: <a href="https://tiktok.com/@vaddzy7" target="_blank">tiktok.com/@vaddzy7</a></div>
      </div>
    </div>
  </aside>
</main>

<!-- modal -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:2000">
  <div id="modalContent" style="background:var(--card);padding:16px;border-radius:10px;max-width:820px;width:100%;max-height:90vh;overflow:auto;color:var(--white)"></div>
</div>

<footer>
  &copy; <span id="year"></span> Vaddzy • Demo • Built by Gaston Manirafasha
</footer>

<script>
/* =================================================
   Vaddzy — single-file Instagram-like music demo
   Features:
   - Users (register/login) [localStorage]
   - Upload beats (audio + cover) saved in base64
   - Like/unlike posts (per-user)
   - Comment on posts
   - Follow / Unfollow users
   - Private messaging between users (conversations)
   - Admin dashboard: manage users, posts, site info
   - All data persisted in localStorage keys
   NOTE: For real multi-user persistence, connect to Firebase or another backend.
   Admin seeded: admin / admin123
   ================================================= */

const KEY_USERS = 'vaddzy_users_v2';
const KEY_POSTS = 'vaddzy_posts_v2';
const KEY_MSGS = 'vaddzy_msgs_v2';
const KEY_CURRENT = 'vaddzy_current_v2';
const KEY_SITE = 'vaddzy_site_v2';

// small helpers
const $ = id => document.getElementById(id);
const now = () => new Date().toISOString();
$('year').textContent = new Date().getFullYear();
function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

// --- seed initial data if not present
function seed(){
  if(!localStorage.getItem(KEY_USERS)){
    const admin = { id:'u_admin', name:'Vaddzy Admin', email:'admin@vaddzy.local', username:'admin', password:'admin123', bio:'Admin', avatar:'', role:'admin', following:[], followers:[], created: now() };
    const demo = { id:'u_demo', name:'Nyakabuye Ahead', email:'vaddzy@example.com', username:'vaddzydev', password:'demo', bio:'Producer • Songwriter', avatar:'', role:'user', following:[], followers:[], created: now() };
    localStorage.setItem(KEY_USERS, JSON.stringify([admin,demo]));
  }
  if(!localStorage.getItem(KEY_POSTS)){
    const p = { id:'p_'+Date.now(), owner:'vaddzydev', ownerId:'u_demo', cover:'https://placehold.co/1200x600/0ea5a7/ffffff?text=Vaddzy+Beat', audio:'', caption:'Welcome to Vaddzy — upload your best beats!', likes:0, _likers:[], comments:[], category:'beat', created: now() };
    localStorage.setItem(KEY_POSTS, JSON.stringify([p]));
  }
  if(!localStorage.getItem(KEY_MSGS)){
    localStorage.setItem(KEY_MSGS, JSON.stringify([])); // messages: {id, from, to, text, created}
  }
  if(!localStorage.getItem(KEY_SITE)){
    localStorage.setItem(KEY_SITE, JSON.stringify({ title:'Vaddzy', desc:'Music collaboration platform' }));
  }
}
seed();

// --- storage accessors
function users(){ return JSON.parse(localStorage.getItem(KEY_USERS) || '[]') }
function saveUsers(u){ localStorage.setItem(KEY_USERS, JSON.stringify(u)) }
function posts(){ return JSON.parse(localStorage.getItem(KEY_POSTS) || '[]') }
function savePosts(p){ localStorage.setItem(KEY_POSTS, JSON.stringify(p)) }
function msgs(){ return JSON.parse(localStorage.getItem(KEY_MSGS) || '[]') }
function saveMsgs(m){ localStorage.setItem(KEY_MSGS, JSON.stringify(m)) }
function current(){ return JSON.parse(localStorage.getItem(KEY_CURRENT) || 'null') }
function setCurrent(u){ localStorage.setItem(KEY_CURRENT, JSON.stringify(u)) }
function clearCurrent(){ localStorage.removeItem(KEY_CURRENT) }
function siteInfo(){ return JSON.parse(localStorage.getItem(KEY_SITE) || '{}') }
function saveSite(s){ localStorage.setItem(KEY_SITE, JSON.stringify(s)) }

// UI refs
const feed = $('feed'), profileCard = $('profileCard'), authControls = $('authControls'), composeCard = $('composeCard'),
      messagesCard = $('messagesCard'), adminCard = $('adminCard'), modal = $('modal'), modalContent = $('modalContent');

// Render: top-level
function renderTop(){
  const s = siteInfo();
  if(s.title) $('siteTitle').textContent = s.title;
  if(s.desc) $('siteDesc').textContent = s.desc;
}

// Auth area (top-right)
function renderAuthControls(){
  const cur = current();
  authControls.innerHTML = '';
  if(!cur){
    authControls.innerHTML = `<button class="btn" id="topLogin">Login</button> <button class="btn ghost" id="topReg">Register</button>`;
    $('topLogin').onclick = openLogin;
    $('topReg').onclick = openRegister;
  } else {
    authControls.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <div class="small muted">@${cur.username}</div>
      <button class="btn ghost" id="topProfile">Profile</button>
      <button class="btn" id="topLogout">Logout</button>
    </div>`;
    $('topProfile').onclick = openEditProfile;
    $('topLogout').onclick = ()=> { clearCurrent(); refreshUI(); };
  }
  composeCard.style.display = current() ? 'block' : 'none';
  messagesCard.style.display = current() ? 'block' : 'none';
  adminCard.style.display = (current() && current().role==='admin') ? 'block' : 'none';
}

// profile sidebar
function renderProfileCard(){
  const cur = current();
  if(!cur){
    profileCard.innerHTML = `<h3>Welcome to Vaddzy</h3><p class="small muted">Register or login to upload beats, follow artists and message.</p><div style="margin-top:10px"><button class="btn" onclick="openRegister()">Get started</button></div>`;
  } else {
    profileCard.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
      <div style="width:64px;height:64px;border-radius:12px;overflow:hidden;background:#0b1320">${cur.avatar ? `<img src="${cur.avatar}" style="width:100%;height:100%;object-fit:cover">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:700">${cur.username.charAt(0).toUpperCase()}</div>`}</div>
      <div>
        <div style="font-weight:700">${cur.name} ${cur.role==='admin' ? '• Admin' : ''}</div>
        <div class="small muted">@${cur.username}</div>
        <div style="margin-top:8px" class="small muted">${cur.bio||''}</div>
        <div style="margin-top:8px"><button class="btn" id="editProfileBtn">Edit</button> <button class="btn ghost" id="logoutBtn">Logout</button></div>
        <div style="margin-top:8px" class="small muted">Following: <span class="badge" id="followCount">0</span></div>
      </div>
    </div>`;
    $('editProfileBtn').onclick = openEditProfile;
    $('logoutBtn').onclick = ()=> { clearCurrent(); refreshUI(); };
    const curRef = users().find(u=>u.username===cur.username) || cur;
    $('followCount').textContent = (curRef.following || []).length;
  }
}

// render feed
function renderFeed(filterUser){
  const list = posts().slice().sort((a,b)=> new Date(b.created) - new Date(a.created));
  feed.innerHTML = '';
  if(list.length===0){ $('noPosts').style.display='block'; return } else $('noPosts').style.display='none';
  list.forEach(p=>{
    const owner = users().find(u=>u.username===p.owner) || {name:p.owner, username:p.owner, avatar:''};
    const container = document.createElement('div'); container.className='post card';
    container.innerHTML = `
      <div class="post-head">
        ${owner.avatar ? `<img src="${owner.avatar}" alt="av">` : `<img src="https://placehold.co/80x80/444444/ffffff?text=${owner.username.charAt(0).toUpperCase()}">`}
        <div style="flex:1">
          <div style="font-weight:700">${owner.name || owner.username}</div>
          <div class="small muted">@${owner.username} • ${new Date(p.created).toLocaleString()}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          ${ current() && current().username !== owner.username ? `<button class="follow-btn" data-username="${owner.username}">${ (isFollowing(current().username, owner.username)) ? 'Unfollow' : 'Follow' }</button>` : '' }
          ${ current() && (current().username === owner.username || current().role==='admin') ? `<div><button class="btn ghost edit-post" data-id="${p.id}">Edit</button> <button class="danger del-post" data-id="${p.id}">Delete</button></div>` : '' }
        </div>
      </div>
      ${ p.cover ? `<img class="media" src="${p.cover}" alt="cover">` : '' }
      <div style="padding:12px">
        ${ p.audio ? `<audio controls src="${p.audio}" style="width:100%;margin-bottom:8px"></audio>` : '' }
        <div class="caption"><b>${escapeHtml(p.caption||'')}</b></div>
        <div class="controls" style="margin-top:8px">
          <div class="left">
            <button class="pill like-btn" data-id="${p.id}">${ (p._likers && current() && p._likers.includes(current().username)) ? '♥ Liked' : '♡ Like' }</button>
            <button class="pill comment-btn" data-id="${p.id}">💬 Comment</button>
            <button class="pill ghost share-btn" data-id="${p.id}">Share</button>
            <button class="pill ghost msg-btn" data-owner="${owner.username}">Message</button>
          </div>
          <div class="small muted"><span class="likes-count">${p.likes||0}</span> likes • <span class="small muted">${(p.comments||[]).length} comments</span></div>
        </div>
        <div class="comments" id="comments-${p.id}" style="margin-top:8px">
          ${(p.comments||[]).map(c=>`<div class="comment-row"><b>${escapeHtml(c.user)}</b><div class="muted" style="margin-left:8px">${escapeHtml(c.text)}</div></div>`).join('')}
          ${ current() ? `<form data-id="${p.id}" class="comment-form" style="display:flex;gap:8px;margin-top:8px"><input name="text" placeholder="Add a comment..." style="flex:1;padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)"><button class="btn" type="submit">Send</button></form>` : `<div class="small muted" style="margin-top:8px">Login to comment</div>` }
        </div>
      </div>
    `;
    feed.appendChild(container);

    // events
    container.querySelectorAll('.like-btn').forEach(b => b.onclick = ()=> toggleLike(p.id));
    container.querySelectorAll('.comment-btn').forEach(b => b.onclick = ()=> openCommentsModal(p.id));
    container.querySelectorAll('.share-btn').forEach(b => b.onclick = ()=> sharePost(p.id));
    container.querySelectorAll('.msg-btn').forEach(b => b.onclick = ()=> openMessageWindow(b.dataset.owner));
    container.querySelectorAll('.follow-btn').forEach(b => b.onclick = ()=> { followToggle(b.dataset.username); refreshUI(); });
    container.querySelectorAll('.del-post').forEach(b => b.onclick = ()=> { if(confirm('Delete post?')) deletePost(b.dataset.id); });
    container.querySelectorAll('.edit-post').forEach(b => b.onclick = ()=> openEditPost(b.dataset.id));
    const form = container.querySelector('.comment-form');
    if(form) form.onsubmit = (e)=>{ e.preventDefault(); const txt = form.text.value.trim(); if(txt) addComment(form.dataset.id || form.getAttribute('data-id') || form.getAttribute('data-id'), txt, p.id); addComment(p.id, txt); form.text.value=''; };
  });
}

// follow helpers
function isFollowing(actor, target){
  const u = users().find(x=>x.username===actor);
  return u && (u.following || []).includes(target);
}
function followToggle(targetUsername){
  const cur = current(); if(!cur){ alert('Login to follow users'); return; }
  if(cur.username === targetUsername) return;
  const us = users();
  const me = us.find(x=>x.username===cur.username);
  const them = us.find(x=>x.username===targetUsername);
  if(!me || !them) return;
  me.following = me.following || []; them.followers = them.followers || [];
  if(me.following.includes(targetUsername)){
    me.following = me.following.filter(x=>x!==targetUsername);
    them.followers = them.followers.filter(x=>x!==me.username);
  } else {
    me.following.push(targetUsername);
    them.followers.push(me.username);
  }
  saveUsers(us);
  setCurrent(me);
  refreshUI();
}

// messaging
// msgs stored as array of {id, from, to, text, created}
function userConversations(username){
  return msgs().filter(m => m.from===username || m.to===username).sort((a,b)=> new Date(b.created)-new Date(a.created));
}
function userInbox(username){
  // return unique conversation peers
  const conv = userConversations(username);
  const peers = {};
  conv.forEach(m=>{
    const other = m.from === username ? m.to : m.from;
    if(!peers[other]) peers[other] = m;
  });
  return Object.keys(peers);
}
function renderMessagesList(){
  const cur = current();
  const listEl = $('msgList');
  if(!cur){ listEl.innerHTML = '<div class="small muted">Login to see messages</div>'; return; }
  const peers = userInbox(cur.username);
  if(peers.length===0){ listEl.innerHTML = '<div class="small muted">No conversations yet</div>'; return; }
  listEl.innerHTML = peers.map(p=>{
    const u = users().find(x=>x.username===p) || {username:p};
    return `<div class="msg-item"><div style="width:40px;height:40px;border-radius:8px;background:#0b1320;display:flex;align-items:center;justify-content:center">${u.username.charAt(0).toUpperCase()}</div><div style="flex:1"><b>${u.name||u.username}</b><div class="small muted">@${u.username}</div></div><div><button class="btn ghost" onclick="openMessageWindow('${u.username}')">Open</button></div></div>`;
  }).join('');
}

// open message window
function openMessageWindow(peerUsername){
  const cur = current();
  if(!cur){ alert('Login to message'); return; }
  if(cur.username === peerUsername){ alert('Cannot message yourself'); return; }
  const convo = msgs().filter(m => (m.from===cur.username && m.to===peerUsername) || (m.from===peerUsername && m.to===cur.username)).sort((a,b)=> new Date(a.created)-new Date(b.created));
  showModal(`
    <h3>Chat — @${peerUsername}</h3>
    <div id="chatScroll" style="max-height:320px;overflow:auto;padding:8px;border:1px solid rgba(255,255,255,0.03);border-radius:8px;margin-bottom:8px">
      ${convo.map(m=>`<div style="margin-bottom:8px"><b>${m.from}</b> <div class="small muted">${new Date(m.created).toLocaleString()}</div><div style="margin-top:4px">${escapeHtml(m.text)}</div></div>`).join('')}
    </div>
    <div style="display:flex;gap:8px">
      <input id="msgText" placeholder="Write a message..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--white)">
      <button class="btn" id="sendMsgBtn">Send</button>
    </div>
  `);
  $('sendMsgBtn').onclick = ()=> {
    const txt = $('msgText').value.trim(); if(!txt) return;
    const m = { id:'m_'+Date.now(), from: cur.username, to: peerUsername, text: txt, created: now() };
    const ms = msgs(); ms.push(m); saveMsgs(ms); closeModal(); refreshUI(); openMessageWindow(peerUsername);
  };
}

// comments
function addComment(postId, text){
  if(!text) return;
  const cur = current() || { username:'Guest' };
  const ps = posts();
  const p = ps.find(x=>x.id===postId); if(!p) return;
  p.comments = p.comments || [];
  p.comments.push({ id: Date.now(), user: cur.username, text });
  savePosts(ps); refreshUI();
}

// likes
function toggleLike(postId){
  const cur = current();
  if(!cur){ alert('Login to like'); return; }
  const ps = posts();
  const p = ps.find(x=>x.id===postId); if(!p) return;
  p._likers = p._likers || [];
  if(p._likers.includes(cur.username)){ p._likers = p._likers.filter(x=>x!==cur.username); p.likes = Math.max(0,(p.likes||0)-1); }
  else { p._likers.push(cur.username); p.likes = (p.likes||0)+1; }
  savePosts(ps); refreshUI();
}

// share
function sharePost(postId){
  const url = location.href.split('#')[0] + '#post-' + postId;
  navigator.clipboard?.writeText(url).then(()=> alert('Post link copied'), ()=> alert('Copy failed — link: '+url));
}

// create post (upload files -> base64)
$('btnCreatePost').onclick = ()=> {
  const cur = current(); if(!cur){ alert('Login to post'); return; }
  const coverFile = $('postCover').files[0];
  const audioFile = $('postAudio').files[0];
  const caption = $('postCaption').value.trim();
  if(!audioFile){ alert('Please select an audio file'); return; }
  const readerA = new FileReader();
  readerA.onload = (e) => {
    const audioData = e.target.result;
    if(coverFile){
      const readerC = new FileReader();
      readerC.onload = (ev) => saveNewPost(cur, caption, ev.target.result, audioData);
      readerC.readAsDataURL(coverFile);
    } else {
      saveNewPost(cur, caption, '', audioData);
    }
  };
  readerA.readAsDataURL(audioFile);
};
function saveNewPost(user, caption, coverData, audioData){
  const ps = posts();
  const id = 'p_'+Date.now();
  ps.push({ id, owner: user.username, ownerId: user.id || user.username, cover: coverData, audio: audioData, caption, likes:0, _likers:[], comments:[], category: $('postCategory').value || 'beat', created: now() });
  savePosts(ps);
  $('postCaption').value=''; $('postCover').value=''; $('postAudio').value='';
  refreshUI();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
$('btnClearPost').onclick = ()=> { $('postCaption').value=''; $('postCover').value=''; $('postAudio').value=''; };

// delete post
function deletePost(postId){
  let ps = posts().filter(p => p.id !== postId);
  savePosts(ps); refreshUI();
}

// edit post (owner or admin)
function openEditPost(postId){
  const p = posts().find(x=>x.id===postId); if(!p) return;
  showModal(`<h3>Edit Post</h3><textarea id="editCaption" placeholder="Caption" style="width:100%;min-height:80px">${escapeHtml(p.caption)}</textarea>
    <div style="margin-top:8px"><input type="file" id="editCover" accept="image/*"><input type="file" id="editAudio" accept="audio/*"></div>
    <div style="margin-top:8px"><button class="btn" id="saveEdit">Save</button></div>`);
  $('saveEdit').onclick = ()=> {
    const caption = $('editCaption').value.trim();
    const cfile = $('editCover').files[0];
    const afile = $('editAudio').files[0];
    const ps = posts(); const idx = ps.findIndex(x=>x.id===postId);
    if(idx<0) return;
    const finalize = (coverData, audioData) => {
      if(coverData) ps[idx].cover = coverData;
      if(audioData) ps[idx].audio = audioData;
      ps[idx].caption = caption;
      savePosts(ps); closeModal(); refreshUI();
    };
    if(cfile){
      const rc = new FileReader(); rc.onload = (e)=> {
        if(afile){ const ra = new FileReader(); ra.onload = (ev)=> finalize(e.target.result, ev.target.result); ra.readAsDataURL(afile); }
        else finalize(e.target.result, null);
      }; rc.readAsDataURL(cfile);
    } else if(afile){
      const ra = new FileReader(); ra.onload = (ev)=> finalize(null, ev.target.result); ra.readAsDataURL(afile);
    } else finalize(null,null);
  };
}

// register & login (sidebar)
$('btnRegister').onclick = ()=> {
  const name = $('regName').value.trim(), username = $('regUser').value.trim(), email = $('regEmail').value.trim(), pass = $('regPass').value;
  if(!name||!username||!email||!pass){ alert('Fill all fields'); return; }
  const us = users();
  if(us.find(u=>u.username===username)){ alert('Username taken'); return; }
  const id = 'u_'+Date.now();
  const obj = { id, name, email, username, password: pass, bio:'', avatar:'', role:'user', following:[], followers:[], created: now() };
  us.push(obj); saveUsers(us); setCurrent(obj);
  $('regName').value=''; $('regUser').value=''; $('regEmail').value=''; $('regPass').value='';
  refreshUI();
};
$('btnLogin').onclick = ()=> {
  const username = $('loginUser').value.trim(), pass = $('loginPass').value;
  if(!username||!pass){ alert('Enter credentials'); return; }
  const u = users().find(x=>x.username===username && x.password===pass);
  if(!u){ alert('Invalid credentials'); return; }
  setCurrent(u); $('loginUser').value=''; $('loginPass').value=''; refreshUI();
};
$('btnOpenLogin').onclick = openLogin;

// admin UI render
function renderAdmin(){
  if(!(current() && current().role === 'admin')){ adminCard.style.display='none'; return; }
  adminCard.style.display='block';
  const tbodyU = $('adminUsers').querySelector('tbody');
  const tbodyP = $('adminPosts').querySelector('tbody');
  tbodyU.innerHTML = users().map(u=>`<tr><td>${escapeHtml(u.name)} <div class="small muted">@${u.username} ${u.role==='admin' ? '• admin' : ''}</div></td><td><button class="btn ghost" onclick="viewUser('${u.username}')">View</button> ${u.role!=='admin' ? `<button class="danger" onclick="deleteUser('${u.username}')">Delete</button>` : '' }</td></tr>`).join('');
  tbodyP.innerHTML = posts().map(p=>`<tr><td style="max-width:220px"><div style="display:flex;gap:8px;align-items:center"><img src="${p.cover||'https://placehold.co/120x80/333/fff?text=NO'}" style="width:64px;height:48px;object-fit:cover;border-radius:6px"><div style="font-size:13px">${escapeHtml(p.caption||'')}</div></div></td><td>@${p.owner}</td><td><button class="btn ghost" onclick="adminViewPost('${p.id}')">View</button> <button class="danger" onclick="deletePost('${p.id}')">Delete</button></td></tr>`).join('');
}
window.viewUser = (username)=>{ const u = users().find(x=>x.username===username); if(!u) return alert('Not found'); showModal(`<h3>${escapeHtml(u.name)}</h3><p class="small muted">@${u.username}</p><p class="small muted">Email: ${escapeHtml(u.email)}</p><p class="small muted">${escapeHtml(u.bio||'')}</p>`); }
window.deleteUser = (username)=>{ if(!confirm('Delete user '+username+'?')) return; let us = users().filter(u=>u.username!==username); saveUsers(us); let ps = posts().filter(p=>p.owner!==username); savePosts(ps); refreshUI(); }
window.adminViewPost = (id)=>{ const p = posts().find(x=>x.id===id); if(!p) return; showModal(`<img src="${p.cover}" style="width:100%;height:auto;object-fit:cover"><div style="margin-top:8px"><b>@${p.owner}</b> <div class="small muted">${new Date(p.created).toLocaleString()}</div></div><div style="margin-top:8px">${escapeHtml(p.caption)}</div>`); }

// site info edit
$('btnEditSite').onclick = ()=> {
  const s = siteInfo();
  showModal(`<h3>Edit Site Info</h3><input id="siteTitleInput" placeholder="Title" value="${escapeHtml(s.title||'Vaddzy')}" style="width:100%;padding:8px;border-radius:6px"><textarea id="siteDescInput" placeholder="Description" style="width:100%;padding:8px;border-radius:6px;margin-top:8px">${escapeHtml(s.desc||'')}</textarea><div style="margin-top:8px"><button class="btn" id="saveSiteBtn">Save</button></div>`);
  $('saveSiteBtn').onclick = ()=> {
    const t = $('siteTitleInput').value.trim(), d = $('siteDescInput').value.trim();
    saveSite({ title: t, desc: d }); closeModal(); refreshUI();
  };
};

// modals
function showModal(html){ modalContent.innerHTML = html + `<div style="margin-top:12px"><button class="btn" id="closeModal">Close</button></div>`; modal.style.display='flex'; $('closeModal').onclick = closeModal; }
function closeModal(){ modal.style.display='none'; modalContent.innerHTML=''; }

// open login/register modal (top)
function openLogin(){ showModal(`<h3>Login</h3><input id="modalLoginUser" placeholder="Username"><input id="modalLoginPass" type="password" placeholder="Password" style="margin-top:8px"><div style="margin-top:8px"><button class="btn" id="modalLoginBtn">Login</button></div>`); $('modalLoginBtn').onclick = ()=> { const u=$('modalLoginUser').value.trim(), p=$('modalLoginPass').value; const user = users().find(x=>x.username===u && x.password===p); if(!user){ alert('Invalid credentials'); return;} setCurrent(user); closeModal(); refreshUI(); }; }
function openRegister(){ showModal(`<h3>Register</h3><input id="modalRegName" placeholder="Full name"><input id="modalRegUser" placeholder="Username" style="margin-top:8px"><input id="modalRegEmail" placeholder="Email" style="margin-top:8px"><input id="modalRegPass" type="password" placeholder="Password" style="margin-top:8px"><div style="margin-top:8px"><button class="btn" id="modalRegBtn">Register</button></div>`); $('modalRegBtn').onclick = ()=> { const name=$('modalRegName').value.trim(), username=$('modalRegUser').value.trim(), email=$('modalRegEmail').value.trim(), pass=$('modalRegPass').value; if(!name||!username||!email||!pass){ alert('Fill all fields'); return; } const us = users(); if(us.find(x=>x.username===username)){ alert('Username taken'); return; } const id = 'u_'+Date.now(); const newu = { id, name, email, username, password:pass, bio:'', avatar:'', role:'user', following:[], followers:[], created: now() }; us.push(newu); saveUsers(us); setCurrent(newu); closeModal(); refreshUI(); }; }

// edit profile modal
function openEditProfile(){
  const cur = current(); if(!cur){ alert('Login first'); return; }
  showModal(`<h3>Edit Profile</h3><input id="editName" placeholder="Full name" value="${escapeHtml(cur.name||'')}" style="width:100%;padding:8px;border-radius:6px"><input id="editBio" placeholder="Bio" value="${escapeHtml(cur.bio||'')}" style="width:100%;padding:8px;border-radius:6px;margin-top:8px"><input type="file" id="editAvatar" style="margin-top:8px"><div style="margin-top:8px"><button class="btn" id="saveProfile">Save</button></div>`);
  $('saveProfile').onclick = ()=> {
    const name = $('editName').value.trim(), bio = $('editBio').value.trim(), file = $('editAvatar').files[0];
    const us = users(); const idx = us.findIndex(x=>x.username===cur.username); if(idx<0) return;
    us[idx].name = name || us[idx].name; us[idx].bio = bio;
    if(file){
      const r = new FileReader(); r.onload = e => { us[idx].avatar = e.target.result; saveUsers(us); setCurrent(us[idx]); closeModal(); refreshUI(); }; r.readAsDataURL(file);
    } else { saveUsers(us); setCurrent(us[idx]); closeModal(); refreshUI(); }
  };
}

// comments modal
function openCommentsModal(postId){
  const p = posts().find(x=>x.id===postId); if(!p) return;
  showModal(`<h3>Comments</h3><div id="commentsArea" style="max-height:320px;overflow:auto;padding:8px;border:1px solid rgba(255,255,255,0.03);border-radius:8px">${(p.comments||[]).map(c=>`<div style="margin-bottom:8px"><b>${escapeHtml(c.user)}</b><div class="small muted">${escapeHtml(c.text)}</div></div>`).join('')}</div><div style="margin-top:8px">${ current() ? `<input id="commentText" placeholder="Write a comment..." style="width:100%;padding:8px;border-radius:8px;background:transparent;color:var(--white)"><div style="margin-top:8px"><button class="btn" id="sendComment">Send</button></div>` : `<div class="small muted">Login to comment</div>` }</div>`);
  if(current()){ $('sendComment').onclick = ()=> { const t = $('commentText').value.trim(); if(!t) return; addComment(postId,t); closeModal(); openCommentsModal(postId); } }
}

// search
$('btnSearch').onclick = ()=> {
  const q = $('searchInput').value.trim().toLowerCase();
  if(!q){ renderFeed(); return; }
  const u = users().find(x=>x.username.toLowerCase()===q || (x.name||'').toLowerCase().includes(q));
  if(u) { showModal(`<h3>${escapeHtml(u.name)}</h3><div class="small muted">@${u.username}</div><div style="margin-top:8px">${escapeHtml(u.bio||'')}</div><div style="margin-top:8px"><button class="btn" onclick="openMessageWindow('${u.username}')">Message</button> <button class="btn ghost" onclick="followToggle('${u.username}'); closeModal(); refreshUI();">${ isFollowing(current()?.username, u.username) ? 'Unfollow' : 'Follow' }</button></div>`); }
  else alert('No user found');
};

// refresh all UI
function refreshUI(){
  renderTop(); renderAuthControls(); renderProfileCard(); renderFeed(); renderMessagesList(); renderAdmin();
  // update compose avatar and name
  const cur = current();
  $('composeAvatar').textContent = cur ? (cur.avatar ? '' : cur.username.charAt(0).toUpperCase()) : 'U';
  if(cur && cur.avatar) $('composeAvatar').innerHTML = `<img src="${cur.avatar}" style="width:56px;height:56px;border-radius:12px;object-fit:cover">`;
  $('composeUser').textContent = cur ? cur.username : 'You';
}

// helper: open message list -> modal show conversation with selected peer
// implemented above as openMessageWindow

// share deep link on load
if(location.hash && location.hash.startsWith('#post-')){
  const id = location.hash.replace('#post-','');
  setTimeout(()=>{ const p = posts().find(x=>x.id===id); if(p) { showModal(`<h3>Shared post</h3><img src="${p.cover}" style="width:100%;height:auto;object-fit:cover"><div style="margin-top:8px"><b>@${p.owner}</b> <div class="small muted">${new Date(p.created).toLocaleString()}</div></div><div style="margin-top:8px">${escapeHtml(p.caption)}</div>`); } },400);
}

// initial binding: open login/register top buttons are dynamic in renderAuthControls
// wire admin view functions for global scope (used in generated HTML)
window.openRegister = openRegister;
window.openLogin = openLogin;
window.openEditProfile = openEditProfile;
window.openMessageWindow = openMessageWindow;
window.followToggle = followToggle;
window.deletePost = deletePost;
window.deleteUser = window.deleteUser || function(u){ if(!confirm('Delete user?')) return; let us = users().filter(x=>x.username!==u); saveUsers(us); let ps = posts().filter(p=>p.owner!==u); savePosts(ps); refreshUI(); };

// initial UI render
refreshUI();

</script>
</body>
</html>
